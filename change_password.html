<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  
  <title>Đổi mật khẩu - HappyEdu VN</title>

  <link rel="icon" type="image/x-icon" href="logo/favicon.ico">
  <link rel="apple-touch-icon" href="logo/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="logo/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="logo/favicon-16x16.png">

  <script src="https://cdn.tailwindcss.com"></script>
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
  
  <style>
    body {
      min-height: 100vh;
      background: linear-gradient(135deg, #E0F2FE 0%, #BFE7F8 100%);
    }
    
    input:focus {
      outline: none;
      border-color: #0EA5E9;
      box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.1);
    }

    .step-indicator {
      display: grid;
      grid-template-columns: repeat(5, auto);
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 2rem;
    }

    .step {
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .step-circle {
      width: 42px;
      height: 42px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      color: white;
      background-color: #D1D5DB;
      transition: background-color 0.3s ease;
    }

    .step.active .step-circle,
    .step.completed .step-circle {
      background-color: #0EA5E9;
    }

    .step-label {
      margin-top: 0.5rem;
      font-size: 0.75rem;
      text-align: center;
      color: #6B7280;
      max-width: 90px;
    }

    .step-line {
      width: 100%;
      height: 2px;
      background-color: #D1D5DB;
    }

    .step-line.active {
      background-color: #0EA5E9;
    }

    .step-content {
      display: none;
      animation: fadeIn 0.35s ease;
    }

    .step-content.active {
      display: block;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(8px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .back-button-container {
      display: flex;
      margin-bottom: 1rem;
    }

    .back-button {
      background: none;
      border: none;
      color: #0EA5E9;
      cursor: pointer;
      font-size: 1.25rem;
      padding: 0.5rem;
      display: flex;
      align-items: center;
      gap: 0.25rem;
      transition: color 0.2s ease;
    }

    .back-button:hover {
      color: #0284C7;
    }
  </style>
</head>
<body>
  <script>
    (function enforceAuth() {
      const path = window.location.pathname.split('/').pop() || 'index.html';
      const publicPages = ['login.html', 'register.html', 'otp.html', 'change_password.html'];
      const isPublic = publicPages.includes(path);
      const isLoggedIn = !!sessionStorage.getItem('user_id');

      if (!isLoggedIn && !isPublic) {
        window.location.replace('login.html');
      }

      if (isLoggedIn && (path === 'login.html' || path === 'register.html')) {
        window.location.replace('index.html');
      }
    })();
  </script>

  <div class="min-h-screen flex items-center justify-center px-4 py-8">
    <div class="bg-white border border-gray-200 rounded-lg shadow-sm p-8 w-full max-w-md">
      <!-- Back Button -->
      <div class="back-button-container">
        <button class="back-button" onclick="window.history.back()" title="Quay lại">
          <i class="fas fa-arrow-left"></i>
        </button>
      </div>

      <h1 class="text-3xl font-bold text-gray-800 mb-2">Đổi mật khẩu</h1>
      <p class="text-sm text-gray-600 mb-6">Thay đổi mật khẩu của bạn để bảo vệ tài khoản</p>

      <!-- Step Indicator -->
      <div class="step-indicator">
        <div class="step active" id="step-1">
          <div class="step-circle">1</div>
          <div class="step-label">Nhập mật khẩu cũ</div>
        </div>
        <div class="step-line"></div>
        <div class="step" id="step-2">
          <div class="step-circle">2</div>
          <div class="step-label">Mật khẩu mới</div>
        </div>
        <div class="step-line"></div>
        <div class="step" id="step-3">
          <div class="step-circle">3</div>
          <div class="step-label">Xác thực OTP</div>
        </div>
      </div>

      <div id="alert-message" class="hidden mb-4 p-3 rounded text-sm"></div>

      <!-- Step 1: Enter Old Password -->
      <div class="step-content active" id="content-step-1">
        <form id="old-password-form" class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Mật khẩu hiện tại</label>
            <div class="relative">
              <input 
                type="password" 
                id="old-password" 
                name="old-password" 
                required 
                class="w-full px-3 py-2 border border-gray-300 rounded focus:border-blue-600 pr-10"
                placeholder="••••••••"
              />
              <button 
                type="button" 
                class="toggle-password-btn absolute right-2 top-1/2 -translate-y-1/2 text-gray-500 hover:text-gray-700"
                data-target="old-password"
              >
                <i class="fas fa-eye text-sm"></i>
              </button>
            </div>
          </div>

          <button 
            type="submit" 
            class="w-full py-2 bg-blue-600 hover:bg-blue-700 text-white rounded font-medium"
          >
            Tiếp theo
          </button>
        </form>

        <div class="text-center mt-4 pt-4 border-t border-gray-200">
          <p class="text-sm text-gray-600">
            <a href="login.html" class="text-blue-600 hover:text-blue-700 font-medium">
              Quay lại đăng nhập
            </a>
          </p>
        </div>
      </div>

      <!-- Step 2: Enter New Password -->
      <div class="step-content" id="content-step-2">
        <form id="new-password-form" class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Mật khẩu mới</label>
            <div class="relative">
              <input 
                type="password" 
                id="new-password" 
                name="new-password" 
                required 
                minlength="6"
                class="w-full px-3 py-2 border border-gray-300 rounded focus:border-blue-600 pr-10"
                placeholder="Tối thiểu 6 ký tự"
              />
              <button 
                type="button" 
                class="toggle-password-btn absolute right-2 top-1/2 -translate-y-1/2 text-gray-500 hover:text-gray-700"
                data-target="new-password"
              >
                <i class="fas fa-eye text-sm"></i>
              </button>
            </div>
            <p class="text-xs text-gray-500 mt-1">Mật khẩu phải có ít nhất 6 ký tự</p>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Xác nhận mật khẩu mới</label>
            <div class="relative">
              <input 
                type="password" 
                id="confirm-password" 
                name="confirm-password" 
                required 
                class="w-full px-3 py-2 border border-gray-300 rounded focus:border-blue-600 pr-10"
                placeholder="Nhập lại mật khẩu"
              />
              <button 
                type="button" 
                class="toggle-password-btn absolute right-2 top-1/2 -translate-y-1/2 text-gray-500 hover:text-gray-700"
                data-target="confirm-password"
              >
                <i class="fas fa-eye text-sm"></i>
              </button>
            </div>
          </div>

          <div class="flex gap-2">
            <button 
              type="button" 
              id="back-btn-1"
              class="flex-1 py-2 bg-gray-200 hover:bg-gray-300 text-gray-800 rounded font-medium"
            >
              Quay lại
            </button>
            <button 
              type="submit" 
              class="flex-1 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded font-medium"
            >
              Tiếp theo
            </button>
          </div>
        </form>
      </div>

      <!-- Step 3: OTP Verification -->
      <div class="step-content" id="content-step-3">
        <p class="text-sm text-gray-600 mb-4">Nhập mã OTP đã được gửi đến email của bạn</p>

        <form id="otp-form" class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Mã OTP (6 số)</label>
            <input 
              type="text" 
              id="otp-code" 
              name="otp-code" 
              required 
              maxlength="6"
              pattern="[0-9]{6}"
              class="w-full px-3 py-2 border border-gray-300 rounded focus:border-blue-600 text-center text-2xl tracking-widest"
              placeholder="000000"
            />
          </div>

          <div class="flex gap-2">
            <button 
              type="button" 
              id="back-btn-2"
              class="flex-1 py-2 bg-gray-200 hover:bg-gray-300 text-gray-800 rounded font-medium"
            >
              Quay lại
            </button>
            <button 
              type="submit" 
              class="flex-1 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded font-medium"
            >
              Xác nhận
            </button>
          </div>
        </form>

        <div class="text-center mt-4 pt-4 border-t border-gray-200">
          <button id="resend-otp" class="text-sm text-blue-600 hover:text-blue-700">
            Gửi lại mã OTP
          </button>
          <p class="text-xs text-gray-500 mt-2" id="otp-countdown"></p>
        </div>
      </div>
    </div>
  </div>

  <script>
    const OTP_SESSION_KEY = 'change_password_otp_code';
    const OTP_EXPIRY_KEY = 'change_password_otp_expires';
    const OTP_TTL_MS = 5 * 60 * 1000;
    const ACCOUNTS_KEY = 'user_accounts';

    let currentStep = 1;
    let oldPassword = '';
    let newPassword = '';
    let userEmail = '';
    let otpAttempts = 0;
    let otpCountdown = 0;
    let accountCache = null;

    // Get user email from session
    function initPage() {
      userEmail = sessionStorage.getItem('user_email') || 'example@email.com';
      accountCache = getCurrentAccount();
      if (accountCache && accountCache.email) {
        userEmail = accountCache.email;
      }
    }

    function loadAccounts() {
      try {
        const raw = localStorage.getItem(ACCOUNTS_KEY);
        return raw ? JSON.parse(raw) : [];
      } catch (error) {
        console.error('Không thể đọc danh sách tài khoản', error);
        return [];
      }
    }

    function saveAccounts(accounts) {
      localStorage.setItem(ACCOUNTS_KEY, JSON.stringify(accounts));
    }

    function getCurrentAccount() {
      const userId = sessionStorage.getItem('user_id');
      if (!userId) return null;
      return loadAccounts().find(acc => acc.userId === userId) || null;
    }

    // Toggle password visibility
    document.querySelectorAll('.toggle-password-btn').forEach(btn => {
      btn.addEventListener('click', function(e) {
        e.preventDefault();
        const targetId = this.dataset.target;
        const input = document.getElementById(targetId);
        const icon = this.querySelector('i');
        
        if (input.type === 'password') {
          input.type = 'text';
          icon.classList.remove('fa-eye');
          icon.classList.add('fa-eye-slash');
        } else {
          input.type = 'password';
          icon.classList.remove('fa-eye-slash');
          icon.classList.add('fa-eye');
        }
      });
    });

    // Step 1: Old Password
    document.getElementById('old-password-form').addEventListener('submit', function(e) {
      e.preventDefault();
      oldPassword = document.getElementById('old-password').value;
      
      if (oldPassword.length < 6) {
        showAlert('Mật khẩu phải có ít nhất 6 ký tự', 'error');
        return;
      }

      const account = accountCache || getCurrentAccount();
      if (!account) {
        showAlert('Không thể xác thực tài khoản hiện tại.', 'error');
        return;
      }
      accountCache = account;

      if (account.password !== oldPassword) {
        showAlert('Mật khẩu hiện tại không khớp', 'error');
        return;
      }
      
      goToStep(2);
    });

    // Step 2: New Password
    document.getElementById('new-password-form').addEventListener('submit', function(e) {
      e.preventDefault();
      const newPwd = document.getElementById('new-password').value;
      const confirmPwd = document.getElementById('confirm-password').value;
      
      if (newPwd !== confirmPwd) {
        showAlert('Mật khẩu xác nhận không khớp', 'error');
        return;
      }
      
      if (newPwd === oldPassword) {
        showAlert('Mật khẩu mới phải khác với mật khẩu cũ', 'error');
        return;
      }
      
      if (newPwd.length < 6) {
        showAlert('Mật khẩu phải có ít nhất 6 ký tự', 'error');
        return;
      }
      
      newPassword = newPwd;
      sendOTP().finally(() => goToStep(3));
    });

    // Step 3: OTP Verification
    document.getElementById('otp-form').addEventListener('submit', async function(e) {
      e.preventDefault();
      const otpCode = document.getElementById('otp-code').value;

      const backendVerify = await verifyOtpWithBackend(otpCode);
      if (backendVerify.success) {
        const backendReset = await resetPasswordWithBackend(newPassword);
        if (!backendReset.success) {
          showAlert(backendReset.message || 'Không thể cập nhật mật khẩu qua server', 'error');
          return;
        }
        updatePassword();
        showAlert('Mật khẩu đã được thay đổi thành công!', 'success');
        setTimeout(() => {
          window.location.href = 'index.html';
        }, 2000);
        return;
      }

      const storedOtp = localStorage.getItem(OTP_SESSION_KEY) || sessionStorage.getItem(OTP_SESSION_KEY);
      const expiry = Number(localStorage.getItem(OTP_EXPIRY_KEY) || sessionStorage.getItem(OTP_EXPIRY_KEY));
      const now = Date.now();
      if (!storedOtp || now > expiry) {
        showAlert('Mã OTP đã hết hạn, vui lòng gửi lại.', 'error');
        return;
      }

      if (otpCode === storedOtp) {
        updatePassword();
        showAlert('Mật khẩu đã được thay đổi thành công!', 'success');
        setTimeout(() => {
          window.location.href = 'index.html';
        }, 2000);
      } else {
        otpAttempts++;
        if (otpAttempts >= 3) {
          showAlert('Bạn đã nhập sai OTP quá nhiều lần. Vui lòng thử lại sau.', 'error');
          document.getElementById('otp-form').style.opacity = '0.5';
          document.getElementById('otp-form').style.pointerEvents = 'none';
        } else {
          showAlert(`Mã OTP không chính xác. Còn ${3 - otpAttempts} lần thử.`, 'error');
        }
        document.getElementById('otp-code').value = '';
      }
    });

    // Back buttons
    document.getElementById('back-btn-1').addEventListener('click', () => goToStep(1));
    document.getElementById('back-btn-2').addEventListener('click', () => goToStep(2));

    // Resend OTP
    document.getElementById('resend-otp').addEventListener('click', function(e) {
      e.preventDefault();
      sendOTP();
    });

    async function sendOTP(options = {}) {
      const { showUserMessage = true } = options;
      otpCountdown = 60;
      otpAttempts = 0;
      updateOTPCountdown();
      const otpForm = document.getElementById('otp-form');
      otpForm.style.opacity = '';
      otpForm.style.pointerEvents = '';

      const generatedOTP = Math.floor(100000 + Math.random() * 900000).toString();
      sessionStorage.setItem(OTP_SESSION_KEY, generatedOTP);
      sessionStorage.setItem(OTP_EXPIRY_KEY, Date.now() + OTP_TTL_MS);
      localStorage.setItem(OTP_SESSION_KEY, generatedOTP);
      localStorage.setItem(OTP_EXPIRY_KEY, Date.now() + OTP_TTL_MS);

      const payload = {
        email: userEmail
      };

      let backendMessage = '';
      let backendSuccess = false;
      try {
        const response = await fetch('/api/auth/forgot-password', {
          method: 'POST',
          credentials: 'include',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const data = await response.json().catch(() => ({}));
        backendSuccess = response.ok && data.success;
        backendMessage = data.message || '';
        if (!backendSuccess) {
          console.warn('OTP backend responded with status', response.status, backendMessage);
        }
      } catch (error) {
        backendMessage = 'Không thể kết nối server gửi OTP';
        console.warn('OTP backend unavailable', error);
      }

      console.log('OTP sent to:', userEmail, generatedOTP);

      if (showUserMessage) {
        if (backendSuccess) {
          showAlert('Mã OTP đã được gửi đến email của bạn', 'success');
        } else {
          showAlert('Hệ thống email chưa sẵn sàng, vui lòng sử dụng mã hiển thị trên console', 'warning');
        }
      }

      return backendSuccess;
    }

    function goToStep(step) {
      currentStep = step;
      
      // Update step indicators
      for (let i = 1; i <= 3; i++) {
        const stepEl = document.getElementById(`step-${i}`);
        const contentEl = document.getElementById(`content-step-${i}`);
        
        if (i < step) {
          stepEl.classList.add('completed');
          stepEl.classList.remove('active');
        } else if (i === step) {
          stepEl.classList.add('active');
          stepEl.classList.remove('completed');
        } else {
          stepEl.classList.remove('active', 'completed');
        }
        
        contentEl.classList.toggle('active', i === step);
      }

      document.querySelectorAll('.step-line').forEach((line, index) => {
        line.classList.toggle('active', index < step - 1);
      });
      
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function updateOTPCountdown() {
      const countdownEl = document.getElementById('otp-countdown');
      const resendBtn = document.getElementById('resend-otp');
      
      if (otpCountdown > 0) {
        countdownEl.textContent = `Gửi lại trong ${otpCountdown}s`;
        resendBtn.style.opacity = '0.5';
        resendBtn.style.pointerEvents = 'none';
        otpCountdown--;
        setTimeout(updateOTPCountdown, 1000);
      } else {
        countdownEl.textContent = '';
        resendBtn.style.opacity = '1';
        resendBtn.style.pointerEvents = 'auto';
      }
    }

    async function verifyOtpWithBackend(code) {
      try {
        const response = await fetch('/api/auth/verify-otp', {
          method: 'POST',
          credentials: 'include',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email: userEmail, otp_code: code })
        });
        const data = await response.json().catch(() => ({}));
        return { success: response.ok && data.success, message: data.message };
      } catch (error) {
        console.warn('OTP verification backend unavailable', error);
        return { success: false };
      }
    }

    async function resetPasswordWithBackend(password) {
      try {
        const response = await fetch('/api/auth/reset-password', {
          method: 'POST',
          credentials: 'include',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email: userEmail, new_password: password })
        });
        const data = await response.json().catch(() => ({}));
        return { success: response.ok && data.success, message: data.message };
      } catch (error) {
        console.warn('Reset password backend unavailable', error);
        return { success: false }; 
      }
    }

    function updatePassword() {
      // Update password in sessionStorage and localStorage
      // In real scenario: update with backend
      const profileKey = 'student_protect_profile';
      const profile = JSON.parse(localStorage.getItem(profileKey) || '{}');
      
      if (!profile.security) {
        profile.security = {};
      }
      
      const today = new Date().toLocaleDateString('vi-VN');
      profile.security.lastPasswordChange = today;
      
      localStorage.setItem(profileKey, JSON.stringify(profile));
      const accounts = loadAccounts();
      const userId = sessionStorage.getItem('user_id');
      const idx = accounts.findIndex(acc => acc.userId === userId);
      if (idx !== -1) {
        accounts[idx].password = newPassword;
        saveAccounts(accounts);
        accountCache = accounts[idx];
      }
      sessionStorage.removeItem(OTP_SESSION_KEY);
      sessionStorage.removeItem(OTP_EXPIRY_KEY);
      localStorage.removeItem(OTP_SESSION_KEY);
      localStorage.removeItem(OTP_EXPIRY_KEY);
    }

    function showAlert(message, type) {
      const alertEl = document.getElementById('alert-message');
      alertEl.textContent = message;
      alertEl.classList.remove('hidden');
      
      if (type === 'error') {
        alertEl.className = 'mb-4 p-3 rounded text-sm bg-red-100 text-red-700 border border-red-300';
      } else if (type === 'success') {
        alertEl.className = 'mb-4 p-3 rounded text-sm bg-green-100 text-green-700 border border-green-300';
      } else if (type === 'warning') {
        alertEl.className = 'mb-4 p-3 rounded text-sm bg-yellow-50 text-yellow-700 border border-yellow-200';
      }
      
      setTimeout(() => {
        alertEl.classList.add('hidden');
      }, 5000);
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', initPage);
  </script>
</body>
</html>
