<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  
  <link rel="icon" type="image/x-icon" href="logo/favicon.ico">
  <link rel="apple-touch-icon" href="logo/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="logo/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="logo/favicon-16x16.png">

  <title>Đăng ký - HappyEdu VN</title>

  <script src="https://cdn.tailwindcss.com"></script>
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
  
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  
  <style>
    body {
      min-height: 100vh;
      background: linear-gradient(135deg, #E0F2FE 0%, #BFE7F8 100%);
    }
    
    input:focus, textarea:focus, select:focus {
      outline: none;
      border-color: #0EA5E9;
      box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.1);
    }

    .password-strength {
      height: 3px;
      transition: all 0.3s;
    }

    /* Tab animations */
    .tabs-container {
      position: relative;
      min-height: auto;
      transition: min-height 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    .tab-content {
      opacity: 0;
      transform: scale(0.97) translateY(8px);
      pointer-events: none;
      transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
      position: absolute;
      width: 100%;
      left: 0;
      top: 0;
    }

    .tab-content.active {
      opacity: 1;
      transform: scale(1) translateY(0);
      pointer-events: auto;
      position: relative;
      top: auto;
      left: auto;
    }

    /* Tab buttons with sliding underline */
    .tab-buttons-container {
      display: flex;
      gap: 1rem;
      position: relative;
      border-bottom: 2px solid #E5E7EB;
      margin-bottom: 1.5rem;
    }

    .tab-button {
      padding: 0.5rem 0;
      font-weight: 500;
      color: #6B7280;
      background: none;
      border: none;
      cursor: pointer;
      transition: color 0.3s ease;
      position: relative;
      font-size: 1rem;
    }

    .tab-button:hover {
      color: #0EA5E9;
    }

    .tab-button.active {
      color: #0EA5E9;
    }

    /* Animated underline */
    .tab-button::after {
      content: '';
      position: absolute;
      bottom: -2px;
      left: 0;
      width: 100%;
      height: 2px;
      background-color: #0EA5E9;
      transform: scaleX(0);
      transform-origin: left;
      transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    .tab-button.active::after {
      transform: scaleX(1);
    }
  </style>
</head>
<body class="light-blue-bg">
  <script>
    (function enforceAuth() {
      const path = window.location.pathname.split('/').pop() || 'index.html';
      const publicPages = ['login.html', 'register.html', 'otp.html'];
      const isPublic = publicPages.includes(path);
      const isLoggedIn = !!sessionStorage.getItem('user_id');

      if (!isLoggedIn && !isPublic) {
        window.location.replace('login.html');
      }

      if (isLoggedIn && (path === 'login.html' || path === 'register.html')) {
        window.location.replace('index.html');
      }
    })();
  </script>

  <div class="min-h-screen flex items-center justify-center px-4">
    <div class="bg-white border border-gray-200 rounded-lg shadow-sm p-8 w-full max-w-md">
      <!-- Tab Toggle -->
      <div class="tab-buttons-container">
        <button type="button" id="student-tab" class="tab-button active" onclick="switchRegTab('student')">
          Học Sinh
        </button>
        <button type="button" id="teacher-tab" class="tab-button" onclick="switchRegTab('teacher')">
          Giáo Viên
        </button>
        <button type="button" id="parent-tab" class="tab-button" onclick="switchRegTab('parent')">
          Phụ Huynh
        </button>
      </div>

      <div class="tabs-container">
        <!-- Student Register Form -->
        <div id="student-form" class="tab-content active">
          <h2 class="text-2xl font-bold text-gray-800 mb-6">Đăng ký tài khoản</h2>

          <div id="alert-message" class="hidden mb-4 p-3 rounded text-sm"></div>

          <form id="register-form" class="space-y-4">
        
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Họ và tên</label>
              <input 
                type="text" 
                id="name" 
                name="name" 
                class="w-full px-3 py-2 border border-gray-300 rounded focus:border-green-600"
                placeholder="Nguyễn Văn A"
              />
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Email <span class="text-red-500">*</span></label>
              <input 
                type="email" 
                id="email" 
                name="email" 
                required 
                class="w-full px-3 py-2 border border-gray-300 rounded focus:border-blue-600"
                placeholder="example@email.com"
              />
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Mật khẩu <span class="text-red-500">*</span></label>
              <div class="relative">
                <input 
                  type="password" 
                  id="password" 
                  name="password" 
                  required 
                  minlength="6"
                  class="w-full px-3 py-2 border border-gray-300 rounded focus:border-blue-600 pr-10"
                  placeholder="Tối thiểu 6 ký tự"
                />
                <button 
                  type="button" 
                  id="toggle-password"
                  class="absolute right-2 top-1/2 -translate-y-1/2 text-gray-500 hover:text-gray-700"
                >
                  <i class="fas fa-eye text-sm"></i>
                </button>
              </div>
              
              <div class="mt-2 rounded-full overflow-hidden bg-gray-200">
                <div id="password-strength" class="password-strength bg-gray-300"></div>
              </div>
              <p id="password-hint" class="text-xs text-gray-500 mt-1"></p>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Xác nhận mật khẩu <span class="text-red-500">*</span></label>
              <div class="relative">
                <input 
                  type="password" 
                  id="confirm-password" 
                  name="confirm-password" 
                  required 
                  class="w-full px-3 py-2 border border-gray-300 rounded focus:border-blue-600 pr-10"
                  placeholder="Nhập lại mật khẩu"
                />
                <button 
                  type="button" 
                  id="toggle-confirm-password"
                  class="absolute right-2 top-1/2 -translate-y-1/2 text-gray-500 hover:text-gray-700"
                >
                  <i class="fas fa-eye text-sm"></i>
                </button>
              </div>
            </div>

            <div class="flex items-start">
              <input 
                type="checkbox" 
                id="terms" 
                name="terms" 
                required 
                class="mt-1 mr-2 w-4 h-4 text-blue-600 border-gray-300 rounded"
              />
              <label for="terms" class="text-xs text-gray-600">
                Tôi đồng ý với Điều khoản sử dụng và Chính sách bảo mật
              </label>
            </div>

            <button 
              type="submit" 
              class="w-full py-2 bg-blue-600 hover:bg-blue-700 text-white rounded font-medium"
            >
              Đăng ký
            </button>
          </form>

          <div class="text-center mt-4 pt-4 border-t border-gray-200">
            <p class="text-sm text-gray-600">
              Đã có tài khoản? 
              <a href="/login.html" class="text-blue-600 hover:text-blue-700 font-medium">
                Đăng nhập ngay
              </a>
            </p>
          </div>
        </div>

        <!-- Teacher Register Form -->
        <div id="teacher-form" class="tab-content">
          <h2 class="text-2xl font-bold text-gray-800 mb-6">Đăng ký Giáo Viên</h2>

          <div id="teacher-alert-message" class="hidden mb-4 p-3 rounded text-sm"></div>

          <form id="teacher-register-form" class="space-y-4">
          
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Tên Giáo Viên</label>
              <input 
                type="text" 
                id="teacher-name-reg" 
                name="teacher_name" 
                required 
                class="w-full px-3 py-2 border border-gray-300 rounded focus:border-blue-600"
                placeholder="Nguyễn Văn A"
              />
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Email <span class="text-red-500">*</span></label>
              <input 
                type="email" 
                id="teacher-email" 
                name="email" 
                required 
                class="w-full px-3 py-2 border border-gray-300 rounded focus:border-blue-600"
                placeholder="teacher@email.com"
              />
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Mật khẩu <span class="text-red-500">*</span></label>
              <div class="relative">
                <input 
                  type="password" 
                  id="teacher-password-reg" 
                  name="password" 
                  required 
                  minlength="6"
                  class="w-full px-3 py-2 border border-gray-300 rounded focus:border-blue-600 pr-10"
                  placeholder="Tối thiểu 6 ký tự"
                />
                <button 
                  type="button" 
                  id="toggle-teacher-password-reg"
                  class="absolute right-2 top-1/2 -translate-y-1/2 text-gray-500 hover:text-gray-700"
                >
                  <i class="fas fa-eye text-sm"></i>
                </button>
              </div>
              <div class="mt-2 rounded-full overflow-hidden bg-gray-200">
                <div id="teacher-password-strength" class="password-strength bg-gray-300"></div>
              </div>
              <p id="teacher-password-hint" class="text-xs text-gray-500 mt-1"></p>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Xác nhận mật khẩu <span class="text-red-500">*</span></label>
              <div class="relative">
                <input 
                  type="password" 
                  id="teacher-confirm-password" 
                  name="confirm_password" 
                  required 
                  minlength="6"
                  class="w-full px-3 py-2 border border-gray-300 rounded focus:border-blue-600 pr-10"
                  placeholder="Nhập lại mật khẩu"
                />
                <button 
                  type="button" 
                  id="toggle-teacher-confirm-password"
                  class="absolute right-2 top-1/2 -translate-y-1/2 text-gray-500 hover:text-gray-700"
                >
                  <i class="fas fa-eye text-sm"></i>
                </button>
              </div>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Mã Giáo Viên <span class="text-red-500">*</span></label>
              <input 
                type="password" 
                id="teacher-code-reg" 
                name="teacher_code" 
                required 
                class="w-full px-3 py-2 border border-gray-300 rounded focus:border-blue-600"
                placeholder="••••••••"
              />
              <p class="text-xs text-gray-500 mt-1">Nhập mã được cấp bởi quản trị viên (mặc định: abc123)</p>
            </div>

            <div class="flex items-start">
              <input 
                type="checkbox" 
                id="teacher-terms" 
                name="terms" 
                required 
                class="mt-1 mr-2 w-4 h-4 text-blue-600 border-gray-300 rounded"
              />
              <label for="teacher-terms" class="text-xs text-gray-600">
                Tôi đồng ý với Điều khoản sử dụng và Chính sách bảo mật
              </label>
            </div>

            <button 
              type="submit" 
              class="w-full py-2 bg-blue-600 hover:bg-blue-700 text-white rounded font-medium"
            >
              Đăng ký
            </button>
          </form>

          <div class="text-center mt-4 pt-4 border-t border-gray-200">
            <p class="text-sm text-gray-600">
              Đã có tài khoản? 
              <a href="/login.html" class="text-blue-600 hover:text-blue-700 font-medium">
                Đăng nhập ngay
              </a>
            </p>
          </div>
        </div>

        <!-- Parent Register Form -->
        <div id="parent-form" class="tab-content">
          <h2 class="text-2xl font-bold text-gray-800 mb-6">Đăng ký phụ huynh</h2>

          <div id="parent-alert-message" class="hidden mb-4 p-3 rounded text-sm"></div>

          <form id="parent-register-form" class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Họ tên phụ huynh</label>
              <input 
                type="text" 
                id="parent-name" 
                name="parent_name" 
                required 
                class="w-full px-3 py-2 border border-gray-300 rounded focus:border-blue-600"
                placeholder="Nguyễn Văn A"
              />
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Số điện thoại <span class="text-red-500">*</span></label>
              <input 
                type="tel" 
                id="parent-phone" 
                name="parent_phone" 
                required 
                class="w-full px-3 py-2 border border-gray-300 rounded focus:border-blue-600"
                placeholder="0912xxxxxx"
              />
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Mật khẩu <span class="text-red-500">*</span></label>
              <div class="relative">
                <input 
                  type="password" 
                  id="parent-password-reg" 
                  name="password" 
                  required 
                  minlength="6"
                  class="w-full px-3 py-2 border border-gray-300 rounded focus:border-blue-600 pr-10"
                  placeholder="Tối thiểu 6 ký tự"
                />
                <button 
                  type="button" 
                  id="toggle-parent-password-reg"
                  class="absolute right-2 top-1/2 -translate-y-1/2 text-gray-500 hover:text-gray-700"
                >
                  <i class="fas fa-eye text-sm"></i>
                </button>
              </div>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Xác nhận mật khẩu <span class="text-red-500">*</span></label>
              <div class="relative">
                <input 
                  type="password" 
                  id="parent-confirm-password" 
                  name="confirm_password" 
                  required 
                  minlength="6"
                  class="w-full px-3 py-2 border border-gray-300 rounded focus:border-blue-600 pr-10"
                  placeholder="Nhập lại mật khẩu"
                />
                <button 
                  type="button" 
                  id="toggle-parent-confirm-password"
                  class="absolute right-2 top-1/2 -translate-y-1/2 text-gray-500 hover:text-gray-700"
                >
                  <i class="fas fa-eye text-sm"></i>
                </button>
              </div>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Thông tin học sinh / con (tùy chọn)</label>
              <input 
                type="text" 
                id="parent-child-info" 
                name="child_info" 
                class="w-full px-3 py-2 border border-gray-300 rounded focus:border-blue-600"
                placeholder="Mã HS hoặc tên học sinh"
              />
            </div>

            <div class="flex items-start">
              <input 
                type="checkbox" 
                id="parent-terms" 
                name="terms" 
                required 
                class="mt-1 mr-2 w-4 h-4 text-blue-600 border-gray-300 rounded"
              />
              <label for="parent-terms" class="text-xs text-gray-600">
                Tôi đồng ý với Điều khoản sử dụng và Chính sách bảo mật
              </label>
            </div>

            <button 
              type="submit" 
              class="w-full py-2 bg-blue-600 hover:bg-blue-700 text-white rounded font-medium"
            >
              Đăng ký
            </button>
          </form>

          <div class="text-center mt-4 pt-4 border-t border-gray-200">
            <p class="text-sm text-gray-600">
              Đã có tài khoản? 
              <a href="/login.html" class="text-blue-600 hover:text-blue-700 font-medium">
                Đăng nhập ngay
              </a>
            </p>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <script>
    // Tab switching function
    function switchRegTab(tabName) {
      const tabs = document.querySelectorAll('.tab-content');
      const buttons = document.querySelectorAll('.tab-button');
      
      tabs.forEach(tab => tab.classList.remove('active'));
      buttons.forEach(btn => btn.classList.remove('active'));
      
      document.getElementById(tabName + '-form').classList.add('active');
      document.getElementById(tabName + '-tab').classList.add('active');
    }

    // Toggle password visibility
    function setupPasswordToggle(inputId, buttonId) {
      const btn = document.getElementById(buttonId);
      if (!btn) return;
      
      btn.addEventListener('click', function(e) {
        e.preventDefault();
        const input = document.getElementById(inputId);
        const icon = this.querySelector('i');
        
        if (input.type === 'password') {
          input.type = 'text';
          icon.classList.remove('fa-eye');
          icon.classList.add('fa-eye-slash');
        } else {
          input.type = 'password';
          icon.classList.remove('fa-eye-slash');
          icon.classList.add('fa-eye');
        }
      });
    }
    
    // Setup all password toggles after DOM is ready
    document.addEventListener('DOMContentLoaded', function() {
      setupPasswordToggle('password', 'toggle-password');
      setupPasswordToggle('confirm-password', 'toggle-confirm-password');
      setupPasswordToggle('teacher-password-reg', 'toggle-teacher-password-reg');
      setupPasswordToggle('teacher-confirm-password', 'toggle-teacher-confirm-password');
      setupPasswordToggle('parent-password-reg', 'toggle-parent-password-reg');
      setupPasswordToggle('parent-confirm-password', 'toggle-parent-confirm-password');
    });
    
    // Password strength checker
    document.addEventListener('DOMContentLoaded', function() {
      const passwordInput = document.getElementById('password');
      if (passwordInput) {
        passwordInput.addEventListener('input', function() {
          const password = this.value;
          const strengthBar = document.getElementById('password-strength');
          const hint = document.getElementById('password-hint');
          
          let strength = 0;
          
          if (password.length >= 6) strength++;
          if (password.length >= 10) strength++;
          if (/[a-z]/.test(password) && /[A-Z]/.test(password)) strength++;
          if (/\d/.test(password)) strength++;
          if (/[^a-zA-Z\d]/.test(password)) strength++;
          
          strength = Math.min(strength, 4);
          
          const colors = ['bg-red-500', 'bg-orange-500', 'bg-yellow-500', 'bg-lime-500', 'bg-green-500'];
          const messages = ['Rất yếu', 'Yếu', 'Trung bình', 'Tốt', 'Rất mạnh'];
          const widths = ['20%', '40%', '60%', '80%', '100%'];
          
          if (password.length === 0) {
            strengthBar.style.width = '0%';
            strengthBar.className = 'password-strength bg-gray-300';
            hint.textContent = '';
          } else {
            strengthBar.style.width = widths[strength];
            strengthBar.className = `password-strength ${colors[strength]}`;
            hint.textContent = `Độ mạnh mật khẩu: ${messages[strength]}`;
          }
        });
      }

      const teacherPasswordInput = document.getElementById('teacher-password-reg');
      if (teacherPasswordInput) {
        teacherPasswordInput.addEventListener('input', function() {
          const password = this.value;
          const strengthBar = document.getElementById('teacher-password-strength');
          const hint = document.getElementById('teacher-password-hint');
          
          let strength = 0;
          if (password.length >= 6) strength++;
          if (password.length >= 10) strength++;
          if (/[a-z]/.test(password) && /[A-Z]/.test(password)) strength++;
          if (/\d/.test(password)) strength++;
          if (/[^a-zA-Z\d]/.test(password)) strength++;

          strength = Math.min(strength, 4);

          const colors = ['bg-red-500', 'bg-orange-500', 'bg-yellow-500', 'bg-lime-500', 'bg-green-500'];
          const messages = ['Rất yếu', 'Yếu', 'Trung bình', 'Tốt', 'Rất mạnh'];
          const widths = ['20%', '40%', '60%', '80%', '100%'];

          if (password.length === 0) {
            strengthBar.style.width = '0%';
            strengthBar.className = 'password-strength bg-gray-300';
            hint.textContent = '';
          } else {
            strengthBar.style.width = widths[strength];
            strengthBar.className = `password-strength ${colors[strength]}`;
            hint.textContent = `Độ mạnh mật khẩu: ${messages[strength]}`;
          }
        });
      }
    });
    
    // Show alert message
    function showAlert(message, type = 'error', elementId = 'alert-message') {
      const alertDiv = document.getElementById(elementId);
      alertDiv.className = `mb-4 p-3 rounded text-sm ${
        type === 'error' ? 'bg-red-50 text-red-700 border border-red-200' : 
        type === 'success' ? 'bg-green-50 text-green-700 border border-green-200' :
        'bg-blue-50 text-blue-700 border border-blue-200'
      }`;
      alertDiv.textContent = message;
      alertDiv.classList.remove('hidden');
      
      if (type === 'success') {
        setTimeout(() => {
          alertDiv.classList.add('hidden');
        }, 3000);
      }
    }

    const ACCOUNTS_KEY = 'user_accounts';
    const TEACHER_INVITE_CODE = 'abc123';

    function loadAccounts() {
      try {
        const raw = localStorage.getItem(ACCOUNTS_KEY);
        return raw ? JSON.parse(raw) : [];
      } catch (error) {
        console.error('Không thể đọc danh sách tài khoản', error);
        return [];
      }
    }

    function saveAccounts(accounts) {
      localStorage.setItem(ACCOUNTS_KEY, JSON.stringify(accounts));
    }

    function normalizeEmail(value) {
      return (value || '').trim().toLowerCase();
    }

    function normalizePhone(value) {
      return (value || '').replace(/\D/g, '');
    }

    function emailExists(email) {
      const normalized = normalizeEmail(email);
      return normalized && loadAccounts().some(acc => acc.email === normalized);
    }

    function phoneExists(phone) {
      const normalized = normalizePhone(phone);
      return normalized && loadAccounts().some(acc => acc.phone === normalized);
    }

    function generateUserId(role) {
      const rolePrefixes = { GV: 'GV', PH: 'PH' };
      const prefix = rolePrefixes[role] || 'HS';
      const accounts = loadAccounts();
      let userId;
      do {
        userId = `${prefix}${Math.floor(100000 + Math.random() * 900000)}`;
      } while (accounts.some(acc => acc.userId === userId));
      return userId;
    }

    function createAccount({ name, email = '', phone = '', password, role, extra = {}, autoFinalize = false }) {
      const normalizedEmail = normalizeEmail(email);
      const normalizedPhone = normalizePhone(phone);

      if (!normalizedEmail && !normalizedPhone) {
        return { success: false, message: 'Vui lòng cung cấp email hoặc số điện thoại' };
      }

      if (normalizedEmail && emailExists(normalizedEmail)) {
        return { success: false, message: 'Email này đã được sử dụng' };
      }

      if (normalizedPhone && phoneExists(normalizedPhone)) {
        return { success: false, message: 'Số điện thoại này đã được sử dụng' };
      }

      const userId = generateUserId(role);

      const defaultNames = { GV: 'Giáo viên', PH: 'Phụ huynh' };
      const pendingAccount = {
        userId,
        name: (name || '').trim() || defaultNames[role] || 'Học sinh',
        email: normalizedEmail,
        phone: normalizedPhone,
        password,
        role,
        ...extra
      };

      if (autoFinalize) {
        const accounts = loadAccounts();
        accounts.push(pendingAccount);
        saveAccounts(accounts);
        return { success: true, userId, email: normalizedEmail, phone: normalizedPhone };
      }

      sessionStorage.setItem('pending_account', JSON.stringify(pendingAccount));
      sessionStorage.setItem('pending_email', normalizedEmail);

      return { success: true, userId, email: normalizedEmail };
    }

    async function sendOTPEmail(email, role) {
      try {
        const response = await fetch('/api/auth/send-otp', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ email, role })
        });
        const data = await response.json();
        return data.success;
      } catch (error) {
        console.error('Error sending OTP:', error);
        // For local development without backend, auto-approve OTP sending
        // In production, this should fail and notify user
        console.warn('OTP send failed - using local development mode');
        return true;
      }
    }
    
    // Handle register form submission
    document.addEventListener('DOMContentLoaded', function() {
      const registerForm = document.getElementById('register-form');
      if (registerForm) {
        registerForm.addEventListener('submit', async function(e) {
          e.preventDefault();
          
          const name = document.getElementById('name').value;
          const email = document.getElementById('email').value;
          const password = document.getElementById('password').value;
          const confirmPassword = document.getElementById('confirm-password').value;
          const terms = document.getElementById('terms').checked;
          
          if (password.length < 6) {
            showAlert('Mật khẩu phải có ít nhất 6 ký tự', 'error');
            return;
          }
          
          if (password !== confirmPassword) {
            showAlert('Mật khẩu xác nhận không khớp', 'error');
            return;
          }
          
          if (!terms) {
            showAlert('Bạn phải đồng ý với điều khoản sử dụng', 'error');
            return;
          }
          
          const submitBtn = this.querySelector('button[type="submit"]');
          const originalText = submitBtn.innerHTML;
          submitBtn.disabled = true;
          submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Đang xử lý...';

          const result = createAccount({ name, email, password, role: 'HS' });
          
          if (!result.success) {
            showAlert(result.message, 'error');
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalText;
            return;
          }

          const otpSent = await sendOTPEmail(email, 'HS');
          
          if (!otpSent) {
            showAlert('Lỗi gửi mã OTP. Vui lòng thử lại.', 'error');
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalText;
            return;
          }
          
          showAlert(`Mã xác thực đã được gửi đến ${email}. Vui lòng kiểm tra email của bạn.`, 'success');
          setTimeout(() => {
            window.location.href = 'otp.html?type=register&email=' + encodeURIComponent(email);
          }, 1500);
        });
      }
    });

    // Handle teacher register form submission
    document.addEventListener('DOMContentLoaded', function() {
      const teacherForm = document.getElementById('teacher-register-form');
      if (teacherForm) {
        teacherForm.addEventListener('submit', async function(e) {
          e.preventDefault();
          
          const teacherName = document.getElementById('teacher-name-reg').value;
          const email = document.getElementById('teacher-email').value;
          const password = document.getElementById('teacher-password-reg').value;
          const confirmPassword = document.getElementById('teacher-confirm-password').value;
          const teacherCode = document.getElementById('teacher-code-reg').value;
          const terms = document.getElementById('teacher-terms').checked;

          if (password.length < 6) {
            showAlert('Mật khẩu phải có ít nhất 6 ký tự', 'error', 'teacher-alert-message');
            return;
          }

          if (password !== confirmPassword) {
            showAlert('Mật khẩu xác nhận không khớp', 'error', 'teacher-alert-message');
            return;
          }

          if (!terms) {
            showAlert('Bạn phải đồng ý với điều khoản sử dụng', 'error', 'teacher-alert-message');
            return;
          }

          if (!teacherCode || teacherCode.trim() !== TEACHER_INVITE_CODE) {
            showAlert('Mã giáo viên không hợp lệ', 'error', 'teacher-alert-message');
            return;
          }

          const submitBtn = this.querySelector('button[type="submit"]');
          const originalText = submitBtn.innerHTML;
          submitBtn.disabled = true;
          submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Đang xử lý...';

          const result = createAccount({ name: teacherName, email, password, role: 'GV' });

          if (!result.success) {
            showAlert(result.message, 'error', 'teacher-alert-message');
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalText;
            return;
          }

          const otpSent = await sendOTPEmail(email, 'GV');

          if (!otpSent) {
            showAlert('Lỗi gửi mã OTP. Vui lòng thử lại.', 'error', 'teacher-alert-message');
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalText;
            return;
          }

          showAlert(`Mã xác thực đã được gửi đến ${email}. Vui lòng kiểm tra email của bạn.`, 'success', 'teacher-alert-message');
          setTimeout(() => {
            window.location.href = 'otp.html?type=register&email=' + encodeURIComponent(email);
          }, 1500);
        });
      }
    });

    document.addEventListener('DOMContentLoaded', function() {
      const parentForm = document.getElementById('parent-register-form');
      if (!parentForm) return;

      parentForm.addEventListener('submit', function(e) {
        e.preventDefault();

        const parentName = document.getElementById('parent-name').value;
        const phone = document.getElementById('parent-phone').value;
        const password = document.getElementById('parent-password-reg').value;
        const confirmPassword = document.getElementById('parent-confirm-password').value;
        const childInfo = document.getElementById('parent-child-info').value.trim();
        const terms = document.getElementById('parent-terms').checked;

        if (password.length < 6) {
          showAlert('Mật khẩu phải có ít nhất 6 ký tự', 'error', 'parent-alert-message');
          return;
        }

        if (password !== confirmPassword) {
          showAlert('Mật khẩu xác nhận không khớp', 'error', 'parent-alert-message');
          return;
        }

        if (!terms) {
          showAlert('Bạn phải đồng ý với điều khoản sử dụng', 'error', 'parent-alert-message');
          return;
        }

        const normalizedPhone = normalizePhone(phone);
        if (!normalizedPhone || normalizedPhone.length < 9) {
          showAlert('Số điện thoại không hợp lệ', 'error', 'parent-alert-message');
          return;
        }

        const submitBtn = this.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Đang xử lý...';

        const extra = childInfo ? { childReference: childInfo } : {};
        const result = createAccount({ name: parentName, phone: normalizedPhone, password, role: 'PH', extra, autoFinalize: true });

        if (!result.success) {
          showAlert(result.message, 'error', 'parent-alert-message');
          submitBtn.disabled = false;
          submitBtn.innerHTML = originalText;
          return;
        }

        showAlert(`Đăng ký thành công! Dùng ${normalizedPhone} để đăng nhập.`, 'success', 'parent-alert-message');
        setTimeout(() => {
          window.location.href = 'login.html';
        }, 1500);
      });
    });
  </script>
  
</body>
</html>
